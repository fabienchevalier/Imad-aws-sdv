#CI qui teste le backend situ√© dans la branche master

name: TestAndDeploy

on: [push]

jobs:
  build_test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout master
      uses: actions/checkout@v3
      with:
        ref: 'master'
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    
    - name: Install dependencies to be able to test
      run: python -m pip install --upgrade pip && pip install requests
        
    - name: Build docker-compose
      run: docker-compose up -d
    
    - name: Run test
      run: |
        sleep 10
        python uni_test.py
        

  deploy_to_aws:
    needs: build_test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout master
      uses: actions/checkout@v2
      with:
        ref: 'master'

    - name: Set up aws CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        sudo apt-get install -y python-pip
        sudo apt-get install -y python-setuptools

    - name: Deploy CloudFormation template
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        aws cloudformation deploy \
          --stack-name EC2-CloudApp \
          --template-file infrastructure_as_code/cloudformation/EC2.yml \
          --parameter-overrides Key=Value \
          --region us-east-1





